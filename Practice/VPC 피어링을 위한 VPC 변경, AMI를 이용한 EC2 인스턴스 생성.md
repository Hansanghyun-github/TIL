### 문제 발생 - AWS Data Transfer 요금 왜 나옴?

-> public IP를 이용해서 EC2끼리 통신하면 데이터 통신한 만큼 요금 나온다고 한다.  
(지역, AZ 같더라도)

> 데이터 통신을 public IP를 이용한 이유  
> -> 어떻게든 요금 아끼려고 프리티어 다계정을 이용해 EC2 인스턴스 여러개 썼다.  
> (dev, monitoring, test 계정들)

https://docs.aws.amazon.com/ko_kr/vpc/latest/peering/what-is-vpc-peering.html

-> 위 사이트를 보면, VPC peering을 이용하면 요금을 없앨 수 있다고 한다.  
(이걸 쓰면 public IP가 아닌 private IP로 통신 가능하다)

### VPC 피어링을 위한 CIDR 설정

그런데 VPC peering을 하려면 CIDR이 달라야 한다고 한다.  
(CIDR: 서브넷팅을 위해(IP 주소 효율적으로 사용하기 위해))

> 문제는 나는 EC2 만들때 VPC 설정을 기본으로 해서, 각각의 계정들의 인스턴스의 VPC CIDR이 다 같았다.

결국 새로 VPC를 생성해야 했다.

---

### VPC 피어링

새로 VPC를 생성하고, VPC 피어링을 했다.

---

그런데 EC2 인스턴스는 중간에 VPC를 변경할 수 없다.

-> 그럼 내가 깔아놓은 프로그램들은 어떻게 되나?  
-> EC2 AMI을 이용하면 그대로 복사해서 EC2 생성할 수 있다고 한다.

---

### AMI(Amazon Machine Images)

EC2 인스턴스 생성에 필요한 소프트웨어 구성(예: 운영 체제, 애플리케이션 서버 및 애플리케이션)이 포함되어 있다.

맨 처음 인스턴스를 생성하기 위해 이를 지정해줘야 한다.  
(내가 아무것도 모르고 지정한 AMI는 AWS에서 기본적으로 제공하는 AMI(우분투, 리눅스, 레드햇 등등 기본 AMI가 있다))

그래서 인스턴스의 AMI를 생성했다.

(AMI는 EBS나 S3에 저장된다)

> AMI에 포함되는 것들 - 내가 설치한 프로그램들, 인스턴스 정보(VPC 등등)  
> AMI에 포함 안되는 것들 - 가상메모리, 프로세스 등 런타임과 관련된 정보들

그래서 생성한 AMI를 이용해 그대로 같은 인스턴스를 VPC만 바꿔서 생성했다.

---

### 새로운 EC2 스왑 영역 설정

기존 EC2에서는 /swapfile 파일을 생성하고 이를 이용해 스왑 영역을 설정했다.

이떄 ami를 이용해 복제했을 떄,  
/swapfile은 남아있지만,  
이를 이용한 스왑 영역 설정은 사라진다.

> AMI는 런타임과 관련된 정보들은 포함하지 않기 때문이다.

남아있는 /swapfile 파일을 이용해 스왑 영역을 설정했다.

---

### VPC 피어링 이후 작업

피어링 이후 작업해야 할 것들
1. 라우팅 테이블에 피어링 한 VPC CIDR을 라우팅 테이블에 추가해줘야 한다.
2. 네트워크 ACL에 피어링 한 VPC CIDR 추가  
   (기본적으로 모두 허용이라 대부분은 안해도 됨)
3. 보안 그룹에 public IP들을 private IP로 변경  
   (보안 그룹은 public/private 관계 없이 특정 IP를 허용할지 말지만 결정하기 때문에 바꿔줘야 한다)  
   (private IP 허용해놓고, public IP로 접근하면 접근 안 된다)
4. 각 프로그램에서 요청하려는 대상의 IP를 public에서 private으로 변경해야 한다.
5. 프로그램 설정 변경한 뒤에 재실행

> 설정 변경하는 놈들 - prometheus, promtail  
> (직접 해당 IP에 접근해서 요청하는 놈들)  
> (loki, spring, node_exporter는 요청이 오면 응답만 하면 되기 때문에 설정이 바뀌지 않는다)

> VPC 피어링을 하면서,  
> 이 과정을 통해 VPC의 구조를 이해했다.  
> (서브넷, 라우팅 테이블, IGW, 네트워크 ACL, NAT(써보지는 않음))
>
> 여기서 알게 된 정보 - 탄력적 IP는 퍼블릭 서브넷만 연결 가능하다.
>
> RDS만들 떄 EC2만 연결되게 만들면, 해당 VPC에 자동으로 프라이빗 서브넷이 생성된다.

> 네트워크 인터페이스(ENI)  
> EC2 등 다양한 인스턴스의 네트워크 관련 정보를 관리하는 인터페이스  
> (인스턴스 당 한개씩 만들어진다)

---

### 보안그룹의 인바운드 규칙을 public IP로 설정했을 떄, private IP를 이용한다면 접속이 가능할까?

이를 알아보기 위해 설정을 바꿨다.

프로메테우스는 public IP 로 요청을 하고,  
대상 컴퓨터는 보안그룹을 private IP로 설정했다.

결과

처음 보안그룹 소스를 public IP -> private IP 했을 떄는 여전히 성공했고,

프로그램을 껐다 키니까 실패했다.

그 이후 프로메테우스의 destination을 private IP로 바꾸니까 성공했다.

> 해당 IP가 public인지 private인지는 보안 그룹에서 보지 않는다.  
> 보안 그룹은 특정 IP를 허용할지 말지만 결정한다.