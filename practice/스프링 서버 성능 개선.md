0-1 아키텍쳐

EC2: t2.micro
(vCPU: 1, 메모리: 1 GiB)

자바 & 스프링으로 서버 구성 

RDS: db.t3.micro  
(vCPU: 2, 메모리: 1 GiB)

MySQL로 DBMS 구성

---

0-2 부하테스트 시나리오

vuser 100명

OAuth2 인증을 받은 vuser가  
20분동안 `/api/articles/main API`를 호출한다.

0-3 DB 데이터

약 80만개의 article 데이터가 있다.  
(500명의 유저가, 최근 2년동안 매일 2개씩 일기를 작성했다고 가정)

main API 조회시, 총 한 달 동안 한 유저가 작성한 일기들을 반환한다.  
(약 60~88개)

---

## TPS, 메트릭 결과

1 맨처음 부하테스트 수행

TPS = 30

visualVM으로 확인한 결과  
CPU 사용량 - 97%, 그 중 GC가 차지하는 비율 - 20%~30%

cloudwatch를 통해 확인한 DB 서버의 CPU 사용량 - 약 20%

## 원인 분석

병목은 스프링 서버에서 발생하고 있었다.

1. 스프링 서버의 병목 원인

top 같은 명령어들로 스레드별 CPU 사용량 분석 결과  
`VM Thread`와 `C2 CompilerThread0` 스레드의 CPU 사용량이 높게 나타났다.  
(이 스레드들은 GC 스레드, JIT 컴파일러 스레드)  
-> 어쩔 수 없이 사용해야 하는 스레드

그 외 스레드들은 모두 1%~2% 점유율을 보였다.  
-> 특정 스레드가 병목을 발생시키는 것이 아니라, 단순히 부하가 많아 CPU 사용량이 높게 나온 것

2. GC 점유율 높은 이유

만약 메모리 누수가 발생했다면 GC 이후 계속 힙 점유율이 높아져야 하는데,  
힙 점유율은 현재 힙 사용량 밑을 유지했다.  
(원활하게 GC가 일어난다는 뜻)

즉 단순히 Garbage Object가 많아서 발생한 문제로 파악된다.

// todo 힙 덤프 분석

---

## 성능 개선

> 적용하기 간단한 순서대로 적용

1. 커넥션 수 줄이기

맨 처음 세션인증을 수행할 때 DB에 조회를 하는데,  
이로 인해 불필요한 커넥션이 소모된다.  
실제 비즈니스 로직에서도 해당 세션의 유효성을 검증하기 떄문에  
세션 인증 단계에서는 DB 조회는 하지 않는 것으로 결정

2. 초기 힙 사이즈 조정

초기 힙 사이즈는 default 값으로 설정되어 있어서,  
GC가 자주 일어나는 것으로 보인다.

-Xms 옵션을 통해 초기 힙 사이즈를 늘리고,  
GC가 자주 일어나지 않도록 설정

3. user.getArticles() 제거

위 로직을 수행하면, 특정 유저의 모든 article 들을 조회한다.  
(날짜에 관계없이)

현재 API에서 원하는건 이번 달에 해당하는 유저의 article만 조회하면 되기 때문에,  
날짜에 의한 필터링 작업을 DB에서 해오는게 좋을 것 같다.

4. DB 인덱스 활용

현재 article을 조회하는 쿼리를 인덱스를 이용하기 위해

(user_id, spend_date) 인덱스를 생성하고,  
인덱스를 타기 위한 쿼리로 로직 변경

> (spend_date, user_id) 인덱스는 비효율적  
> (첫번째 칼럼이 날짜라서 두번째 칼럼으로 필터링 안될 확률 높음)

// todo 인덱스 두가지 성능 테스트 비교

5. 비즈니스 로직 개선

쿼리 조회 2개 -> 1개로 줄여서 테스트

결과 그래프로 출력

// todo 쿼리 줄이는 과정 다이어그램 추가

---

