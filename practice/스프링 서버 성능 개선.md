## Main API란?

스핀로그 사이트에서 로그인을 한 유저는 메인 페이지에 들어가면,  
한 달 동안 작성한 일기들과 오늘 작성한 일기들을 볼 수 있다.

<img src="../img/PerfTest_211.png" width="300">  

(위 데이터들을 가져오는 API)

---

## Main API 부하 테스트 결과

> nGrinder를 이용해 100명의 유저가 20분 동안 Main API를 호출했다.

TPS는 30으로 나왔다.

(visualVM으로 확인한 결과)  
WAS 서버의 CPU 사용량 - 97%, 그 중 GC가 차지하는 비율 - 20%~35%  
<img src="img_5.png" width="600">

(cloudwatch를 통해 확인한 결과)  
DB 서버의 CPU 사용량 - 약 20%  
<img src="img_6.png" width="500">

---

## 원인 분석

병목은 스프링 서버에서 발생하고 있었다.

### 1. 스프링 서버의 병목 원인

htop 명령어를 이용해 스레드별 CPU 사용량 분석 결과  
`VM Thread`와 `C2 CompilerThread0` 스레드의 CPU 사용량이 높게 나타났다.  
(이 스레드들은 GC 스레드, JIT 컴파일러 스레드)  
-> 어쩔 수 없이 사용해야 하는 스레드

그 외 스레드들은 모두 1%~2% 점유율을 보였다.  
-> 특정 스레드가 병목을 발생시키는 것이 아니라, 단순히 부하가 많아 CPU 사용량이 높게 나온 것

### 2. GC 점유율 높은 이유

만약 메모리 누수가 발생했다면 GC 이후 계속 힙 점유율이 높아져야 하는데,  
힙 점유율은 현재 힙 사용량 밑을 유지했다.  
(원활하게 GC가 일어난다는 뜻)

// todo visualVM 힙 메모리 과정 그래프 추가

즉 단순히 Garbage Object가 많아서 발생한 문제로 파악된다.

// todo 힙 덤프 분석

---

## 성능 개선

### 1. 불필요한 커넥션 소모 방지

맨 처음 세션 인증을 수행할 때 DB에 조회를 하는데,  
이로 인해 불필요한 커넥션이 소모된다.

// todo 세션 인증 과정 다이어그램 추가

> 세션 인증 이후,  
> 비즈니스 로직에서도 해당 세션의 유효성을 검증하기 위해,  
> DB 조회를 수행한다.
> 
> -> 중복된 DB 조회가 발생한다.

따라서 세션 인증 단계에서는 DB 조회는 하지 않는 것으로 결정했다.  
(세션의 존재 여부만 확인)

### 2. 데이터를 가져올 때, DB에서 필터링하는 작업 추가

한달치 일기와 오늘 일기를 가져오는 작업을 수행할 때,  
DB로부터 해당 유저의 모든 일기를 가져온 뒤,  
WAS에서 날짜에 대한 필터링 작업을 수행한다.

// todo main API 로직 다이어그램 추가

> `user.getArticles();`  
> 위 코드를 수행하면, 유저의 모든 articles를 조회한다.  
> (날짜에 관계없이)

현재 API에서 원하는건 이번 달에 해당하는 유저의 articles 이다.

> WAS에서 필터링 작업을 수행하면서,  
> 실제로 응답하는 데이터보다 많은 Garbage Object가 생성되고 있을 것이다.

따라서 DB에서 필터링 작업을 수행하도록 변경했다.

// todo 필터링 작업을 수행하는 쿼리로 변경하는 전체 다이어그램 추가

### 3. DB 인덱스 활용

현재 article을 조회하는 쿼리를 인덱스를 이용하기 위해

(user_id, spend_date) 인덱스를 생성하고,  
인덱스를 타기 위한 쿼리로 로직 변경

> (spend_date, user_id) 인덱스는 비효율적  
> (첫번째 칼럼이 날짜라서 두번째 칼럼으로 필터링 안될 확률 높음)

// todo 인덱스 두가지 성능 테스트 비교

### 4. 비즈니스 로직 개선

Main API는 2개의 쿼리를 수행한다.  
(한달치 일기 조회, 오늘 일기 조회)

쿼리 조회 2개 -> 1개로 줄여서 테스트

// todo 쿼리 줄이는 과정 다이어그램 추가

---

## 성능 개선 결과

> cgroup을 이용해 자바 프로그램의 CPU 사용량을 60%로 제한했다.  
> (특정 스레드의 병목 때문이 아닌, 단순히 부하가 많아서 CPU 사용량이 높게 나온 것으로 보이기 때문)

// todo

> 지금도 WAS 서버에서 병목이 발생하지만,  
> 이것은 단순히 부하가 많아서 발생하는 것으로 보인다.  
> 이를 제거하려면 스케일 업이나 스케일 아웃이 필요하다.

