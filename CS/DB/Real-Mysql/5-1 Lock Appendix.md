# 잠금(Lock)

Lock은  
접근 권한을 제어하는 방식에 따라 공유 락, 배타 락  
제어하는 범위에 따라 글로벌 락, 테이블 락, 레코드 락, 갭 락  
으로 나뉜다.

---

### 공유 락(Shared Lock)

(읽기 잠금이라고도 표현한다)

해당 레코드에 대해 읽기 권한을 얻는 락  
A 트랜잭션이 특정 레코드에 대한 공유 락을 가지고 있다면,  
B 트랜잭션은 해당 레코드를 읽기 작업(select)은 할 수 있지만,  
쓰기 작업(update, delete, insert)는 할 수 없다.

```select ... for share``` 쿼리를 보내면 공유 락을 요청할 수 있다.

> 만약 격리 수준이 `SERIALIZABLE`이라면  
> 오토커밋이 OFF인 상태에서 `SELECT` 쿼리도  
> (`SELECT ... FOR SHARE` 처럼 처리되서) 공유 락을 얻어야  
> 레코드를 조회할 수 있다.

### 배타 락(Exclusive Lock)

(쓰기 잠금이라고도 표현한다)

해당 레코드에 대해 쓰기 권한을 얻는 락  
A 트랜잭션이 특정 레코드에 대한 공유 락을 가지고 있다면,  
B 트랜잭션은 해당 레코드에 대한 모든 작업(select, update, delete, insert)을 할 수 없다.

```select ... for update```, `insert`, `update`, `delete` 쿼리를 보내면  
배타 락을 요청할 수 있다.

---

(글로벌 락, 테이블 락은 제외)

아래 락들은 MySQL InnoDB에서 제공하는 기능이다.

---

### 레코드 락(Record Lock)

특정 레코드에 대해 잠금을 거는 것

이때 레코드 자체에 잠금을 거는 것이 아니라,  
인덱스에 잠금을 건다.

이때 주의할 점은  
조건에 맞지 않는 레코드라도  
인덱스로 스캔되면 해당 레코드는 락이 걸린다.  

> 만약 잠금을 거는 쿼리가 인덱스를 이용하지 못한다면  
> (풀 테이블 스캔을 해야한다면)  
> 모든 레코드에 대해 잠금을 건다.  
> (이는 테이블 락보다 비효율적이다)

---

### 갭 락(Gap Lock)

인덱스에서 레코드의 범위에 대해 락을 거는 것

잠금을 거는 쿼리가 인덱스를 범위 조건으로 탐색한다면  
해당 범위에 대해 insert 작업이 들어오는 것을 막는다.

### 갭 락의 범위

(범위 조건에서)  
만약 경계선에 해당하는 레코드가 있다면  
해당 레코드까지의 범위만 락을 걸고,

경계선에 해당하는 레코드가 없다면  
해당 범위의 이전(다음)에 해당하는 레코드까지 갭 락을 건다.

### 갭 락 사용 조건

쿼리가 갭 락을 사용하려면,  
binary log format이 STATEMENT or Mixed 여야 한다.  
그리고 트랜잭션 격리 수준이 REPEATABLE-READ or SERIALIZABLE 여야 한다.
(READ-COMMITTED도 쓸 수 있다고 함)

---

